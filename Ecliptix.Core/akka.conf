akka {
  # Logging configuration
  stdout-loglevel = INFO
  loglevel = INFO
  log-dead-letters = 10
  log-dead-letters-during-shutdown = off

  persistence {
    # SQL persistence (preferred when ECLIPTIX_DB_CONNECTION_STRING is set)
    sql-store {
      journal {
        class = "Akka.Persistence.Sql.Journal.SqlWriteJournal, Akka.Persistence.Sql"
        connection-string = "Data Source=78.152.175.67;Initial Catalog=EcliptixMemberships;Integrated Security=False;User ID=ef_migrator;Password=Grimm_jow92;Connect Timeout=30;Encrypt=False;TrustServerCertificate=True;ApplicationIntent=ReadWrite;MultiSubnetFailover=False;"
        provider-name = "SqlServer"
        schema-name = dbo
        table-name = "journal"
        call-timeout = 60s
        auto-initialize = on
        
        # Circuit breaker for resilience
        circuit-breaker {
          max-failures = 5
          call-timeout = 10s
          reset-timeout = 30s
        }
      }

      snapshot {
        class = "Akka.Persistence.Sql.Snapshot.SqlSnapshotStore, Akka.Persistence.Sql"
        connection-string = "Data Source=78.152.175.67;Initial Catalog=EcliptixMemberships;Integrated Security=False;User ID=ef_migrator;Password=Grimm_jow92;Connect Timeout=30;Encrypt=False;TrustServerCertificate=True;ApplicationIntent=ReadWrite;MultiSubnetFailover=False;"
        provider-name = "SqlServer"
        schema-name = dbo
        table-name = "snapshot"
        call-timeout = 60s
        auto-initialize = on
        
        # Circuit breaker for resilience
        circuit-breaker {
          max-failures = 5
          call-timeout = 10s
          reset-timeout = 30s
        }
      }

      metadata {
        table-name = "Metadata"
      }
    }

    # Local file persistence (fallback when no SQL connection)
    snapshot-store {
      local {
        class = "Akka.Persistence.Snapshot.LocalSnapshotStore, Akka.Persistence"
        dir = "snapshots"
        # Force binary serialization
        auto-initialize = on
      }
    }

    journal {
      inmem {
        class = "Akka.Persistence.Journal.MemoryJournal, Akka.Persistence"
        auto-initialize = on
      }
    }

    # Use SQL persistence when connection string is available, fallback to in-memory for testing
    journal.plugin = "akka.persistence.sql-store.journal"
    snapshot-store.plugin = "akka.persistence.sql-store.snapshot"
    
    # Recovery settings
    recovery {
      replay-filter {
        mode = repair-by-discard-old
        window-size = 100
        max-old-writers = 10
        debug = false
      }
    }
  }
  
  actor {
    ask-timeout = 30s
    
    # Default dispatcher configuration
    default-dispatcher {
      type = Dispatcher
      executor = "fork-join-executor"
      
      fork-join-executor {
        parallelism-min = 2
        parallelism-max = 8
        parallelism-factor = 2.0
      }
      
      throughput = 5
    }
    
    # Dedicated dispatcher for database operations
    database-dispatcher {
      type = Dispatcher
      executor = "thread-pool-executor"
      
      thread-pool-executor {
        fixed-pool-size = 4
        task-queue-size = -1
      }
      
      throughput = 1
    }
    
    serializers {
      protobuf = "Ecliptix.Core.Infrastructure.Serialization.Base64SessionStateSerializer, Ecliptix.Core"
    }

    serialization-bindings {
      "Ecliptix.Protobuf.ProtocolState.EcliptixSessionState, Ecliptix.Protobufs" = protobuf
      "Ecliptix.Protobuf.ProtocolState.IdentityKeysState, Ecliptix.Protobufs" = protobuf
      "Ecliptix.Protobuf.ProtocolState.RatchetState, Ecliptix.Protobufs" = protobuf
      "Ecliptix.Protobuf.ProtocolState.OneTimePreKeySecret, Ecliptix.Protobufs" = protobuf
      "Ecliptix.Protobuf.ProtocolState.ChainStepState, Ecliptix.Protobufs" = protobuf
      "Ecliptix.Protobuf.ProtocolState.CachedMessageKey, Ecliptix.Protobufs" = protobuf
    }
    
    # Coordinated shutdown for graceful termination
    coordinated-shutdown {
      terminate-actor-system = on
      run-by-actor-system-terminate = on
      
      phases {
        before-service-unbind {
          timeout = 10s
        }
        
        service-requests-done {
          timeout = 20s
        }
        
        before-actor-system-terminate {
          timeout = 10s
        }
        
        actor-system-terminate {
          timeout = 20s
        }
      }
    }
  }
}
